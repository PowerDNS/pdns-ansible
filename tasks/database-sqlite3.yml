---

- name: Install the SQLite dependencies on RedHat
  package:
    name: sqlite
    state: present
  when: ansible_os_family == 'RedHat'

- name: Install the SQLite dependencies on Debian
  package:
    name: sqlite3
    state: present
  when: ansible_os_family == 'Debian'

- name: Ensure that the directories containing the PowerDNS SQLite databases exist
  file:
    name: "{{ item | dirname }}"
    owner: "{{ pdns_user }}"
    group: "{{ pdns_group }}"
    state: directory
    mode: 0750
  with_items: "{{ pdns_sqlite_databases_locations }}"

- block:
    - name: Define the PowerDNS SQLite schema file path on RedHat 
      set_fact:
        _pdns_sqlite3_schema_file: "{{ pdns_rh_sqlite3_schema_file }}"
      when: ansible_os_family == "RedHat"

    - name: Create the PowerDNS SQLite databases on RedHat
      shell: "sqlite3 {{ item }} < {{ _pdns_sqlite3_schema_file }}"
      args:
        creates: "{{ item }}"
      with_items: "{{ pdns_sqlite_databases_locations }}"

  when: ansible_os_family == "RedHat"

- block:

    - name: Create the PowerDNS SQLite databases on Debian
      shell: "sqlite3 {{ item }} < {{ pdns_deb_sqlite3_schema_file }}"
      args:
        creates: "{{ item }}"
      with_items: "{{ pdns_sqlite_databases_locations }}"

  when: ansible_os_family == "Debian"

- block:
    - name: Initiate the SQLite database on Arch Linux
      shell: "sqlite3 {{ item }} < {{ pdns_arch_sqlite3_schema_file }}"
      args:
        creates: "{{ item }}"
      with_items: "{{ pdns_sqlite_databases_locations }}"

  when: ansible_os_family == "Archlinux"

- name: Check the PowerDNS SQLite databases permissions
  file:
    name: "{{ item }}"
    owner: "{{ pdns_user }}"
    group: "{{ pdns_group }}"
    mode: 0640
    state: file
  with_items: "{{ pdns_sqlite_databases_locations }}"
